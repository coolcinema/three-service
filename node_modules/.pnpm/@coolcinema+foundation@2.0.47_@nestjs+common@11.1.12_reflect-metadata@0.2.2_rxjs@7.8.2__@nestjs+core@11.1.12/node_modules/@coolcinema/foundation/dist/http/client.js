"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createClient = createClient;
exports.createClients = createClients;
const openapi_fetch_1 = require("openapi-fetch");
const store_1 = require("../context/store");
const propagator_1 = require("../context/propagator");
function createClient(registry, serviceSlug, interfaceName = "main") {
    const serviceConfig = registry.services[serviceSlug];
    if (!serviceConfig) {
        throw new Error(`Service '${serviceSlug}' not found in Registry`);
    }
    const interfaceConfig = serviceConfig.http?.[interfaceName];
    if (!interfaceConfig || !interfaceConfig.port) {
        throw new Error(`HTTP Interface '${interfaceName}' not found (or has no port) for service '${serviceSlug}'. ` +
            `Check coolcinema.yaml: http.${interfaceName}`);
    }
    const baseURL = `http://${serviceConfig.host}:${interfaceConfig.port}`;
    const client = (0, openapi_fetch_1.default)({
        baseUrl: baseURL,
        fetch: async (input, init) => {
            const headers = new Headers(init?.headers);
            const ctx = (0, store_1.getCurrentContext)();
            propagator_1.Propagator.inject(ctx, (key, values) => {
                values.forEach((v) => headers.append(key, v));
            });
            return fetch(input, {
                ...init,
                headers,
            });
        },
    });
    return client;
}
function createClients(registry, serviceMap) {
    const clients = {};
    for (const [key, slug] of Object.entries(serviceMap)) {
        clients[key] = createClient(registry, slug);
    }
    return clients;
}
//# sourceMappingURL=client.js.map
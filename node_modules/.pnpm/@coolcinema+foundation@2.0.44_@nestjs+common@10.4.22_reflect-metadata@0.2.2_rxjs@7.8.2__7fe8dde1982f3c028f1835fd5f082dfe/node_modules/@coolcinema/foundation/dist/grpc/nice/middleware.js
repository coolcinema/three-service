"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serverMiddleware = exports.clientMiddleware = void 0;
const nice_grpc_1 = require("nice-grpc");
const store_1 = require("../../context/store");
const keys_1 = require("../../context/keys");
const propagator_1 = require("../../context/propagator");
const clientMiddleware = async function* (call, options) {
    const ctx = (0, store_1.getCurrentContext)();
    if (ctx) {
        const metadata = options.metadata instanceof nice_grpc_1.Metadata
            ? options.metadata
            : new nice_grpc_1.Metadata(options.metadata);
        propagator_1.Propagator.inject(ctx, (key, values) => {
            values.forEach((v) => metadata.append(key, v));
        });
        options.metadata = metadata;
    }
    return yield* call.next(call.request, options);
};
exports.clientMiddleware = clientMiddleware;
const serverMiddleware = async function* (call, context) {
    const metadata = context.metadata;
    const headers = {};
    for (const key of keys_1.PROPAGATION_HEADERS) {
        const val = metadata.get(key);
        if (val) {
            headers[key] = Array.isArray(val) ? val.map(String) : String(val);
        }
    }
    const appCtx = {
        traceId: typeof headers[keys_1.CONTEXT_KEYS.TRACE_ID] === "string"
            ? headers[keys_1.CONTEXT_KEYS.TRACE_ID]
            : undefined,
        headers,
    };
    const generator = (0, store_1.runInContext)(appCtx, () => call.next(call.request, context));
    return yield* generator;
};
exports.serverMiddleware = serverMiddleware;
//# sourceMappingURL=middleware.js.map